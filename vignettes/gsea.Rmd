---
title: "Gene set expression analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gene set expression analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
set.seed(123)
library(GimmeMyOmics)
org <- "org.Hs.eg.db"
source("R/utils_enrich.R")
source("R/utils_network.R")
```

# Data preparation
```{r, eval = FALSE}
# metric <- "pfc"
# metric <- "ranked_padj"
metric <- "log2FoldChange"
de_genes_ranked <- extract_top(dea_pretty, 0.01, 1, n = 50000, rank = TRUE) %>%
    # mutate(ranked_padj = sign(log2FoldChange) * (log10(padj))) %>%
    pull(metric, name = ensembl_gene_id) %>%
        sort(decreasing = TRUE) %>%
        .[!is.na(names(.))] %>%
        .[is.finite(.)]
length(de_genes_ranked)
```

# GSEA
```{r}
gse_go <- gseGO(
      de_genes_ranked, 
      ont = "ALL",
      OrgDb = get(org),
      keyType = "ENSEMBL",
      verbose = FALSE
      ) %>%
      setReadable(org, 'ENSEMBL')
# saveRDS(gse_go, file = file.path(path, paste0("gse_go", project_name, ".RDS")))
# gse_go <- readRDS(file.path(path, paste0("gse_go", project_name, ".RDS")))
```

# All pathways
```{r}
plot_enrich(gse_go, type = "gsea", label_x = "NES")# + 
# scale_fill_gradientn(
#     labels = function(x) label_pvalue()(x),
#     breaks = c(0.002, 0.001, 0),
#     name = "FDR",
#     limits = c(0, 0.003),
#     colours = c(GimmeMyPlot:::palette_discrete()[1], "gray50", GimmeMyPlot:::palette_discrete()[2])
# ) +
#     scale_size_continuous(
#         range = c(5, 12) * 0.6,
#         breaks = c(50, 100, 150, 200, 250),
#         labels = scales::label_number(accuracy = 1),
#         name = "# Leading genes",
#         limits = c(10, 300)
#     )
(table_gsea <- print_enrich(gse_go, type = "gsea"))
```

# Targeting all immunity 
```{r, message = FALSE}
plot_enrich(gse_go, label_x = "NES", type = "gsea", regex = paste(name_immu2, collapse = "|"))
print_enrich(gse_go, type = "gsea", regex = paste(name_immu2, collapse = "|"))
```

# Targeting only cytokines
```{r}
plot_enrich(gse_go, label_x = "NES", type = "gsea", regex = paste(name_immu0, collapse = "|"))
plot_enrich(gse_go, label_x = "NES", type = "gsea", regex = paste(cytok_paths, collapse = "|"), n = 25)
print_enrich(gse_go, type = "gsea", regex = paste(cytok_paths, collapse = "|"))
```

# Targeting only cell processes
```{r, eval = FALSE}
plot_enrich(gse_go, label_x = "NES", type = "gsea", regex = paste(cell_paths, collapse = "|"))
print_enrich(gse_go, type = "gsea", regex = paste(cell_paths, collapse = "|"))
```

# Targeting a specific pathway
```{r}
(targeted_paths <- print_enrich(gse_go, type = "gsea", regex = "eutrophil activation"))
gene_path <- targeted_paths %>% select(Genes) %>% map(~ str_split(., ";") %>% unlist() %>% sort()) %>% pluck(1)

dea_path <- filter(dea_pretty, name %in% gene_path)
plot_heatmap(dea_path, cutree_cols = 2)

top_genes <- extract_top(
    dea_pretty,
     fc_threshold = fc_threshold,
     p = p_threshold,
     n = 15
   )
top_markers <- pull(top_genes, "name") %>% sort()
intersect(gene_path, top_markers)

top_path_genes <- filter(dea_pretty, name %in% gene_path) %>%
    extract_top(
     fc_threshold = 0,
     p = 1,
     n = 15
   )
volcano_plot(
      dea_pretty,
      top_genes = top_path_genes,
      cex = 1,
      legend = "none",
      fc_threshold = fc_threshold,
      p_threshold = p_threshold
    ) + xlab("") + ylab("")
```

```{r}
library("GimmeMyCluster")

count_normalized <- vst(dea, blind = FALSE)

extract_normalized_genes <- function(x, count_normalized, metadata_samples) {
    assay(count_normalized)[pull(x, 1), ] %>%
    set_colnames(pull(metadata_samples, 1)) %>%
    set_rownames(pull(x, gene_name))
}
targeted_genes <- extract_normalized_genes(dea_path, count_normalized, metadata_samples)
sampleDists <- dist(t(targeted_genes))
  
top_cluster_genes <- getDiscriminantVariables(t(targeted_genes), hclust(sampleDists) %>% cutree(2), n_cluster = 2)
select(top_cluster_genes, 1) %>%
    plot_bar(colour = brewer.pal(7, "Reds") %>% rev() %>% .[-7], sample_size = 100, digits = 1)

gene <- filter(dea_pretty, name == rownames(top_cluster_genes)[1])
gene_per_sample <- plotCounts(
    dea,
    pull(gene, 1),
    intgroup = conditions[-3],
    returnData = TRUE
)

var_group <- "condition"
list.map(
    pull(gene_per_sample, !!sym(var_group)) %>% unique(), 
    f(x) ~filter(gene_per_sample, !!sym(var_group) == x) %>% select(count)
) %>%
    list_cbind0() %>% 
    set_colnames(pull(gene_per_sample, !!sym(var_group)) %>% unique()) %>%
    plot_violin(
        pch_size = 4,
        display_log = TRUE,
        # breaks = c(250, 500, 1e3),
        title = pull(gene, "name")
    )
```

# Multiple related pathways
```{r}
(targeted_paths <- print_enrich(gse_go, type = "gsea", regex = "eutrophil"))
l_path <- list.map(
    pull(targeted_paths, Description), 
    f(i) ~ filter(targeted_paths, Description == i) %>%
        pull(Genes) %>%
        str_split(";") %>%
        pluck(1) %>%
        sort()
    ) %>% set_names(names(.) %>% format_path(100))
gene_path <- unlist(l_path) %>% unique() %>% sort()

filter(dea_pretty, `name` %in% gene_path) %>% plot_heatmap(cutree_cols = 2)
```

```{r}
gene_ont <- "name"
gene_path <- list_table(l_path) %>% rownames()
gene_path0 <- #l_de2[[1]] %>%
  dea_pretty %>%
  filter(str_detect(!!sym(gene_ont), paste0("^", gene_path, "$", collapse = "|"))) %>% 
  extract_top(1e-9, 1, rank = TRUE) %>%
  mutate(pfc = -pfc)
gene_path1 <- gene_path0 %>% 
  filter(!duplicated(!!sym(gene_ont))) %>% 
  set_rownames(pull(., gene_ont)) %>% 
  select(log2FoldChange) %>% 
  set_colnames("value2") %>% 
  rownames_to_column("ID")

common_genes <- list_count(l_path) %>% unlist() %>% unname()

list_count(l_path) %>%
    list.map(
        f(i, j, k) ~unlist(i) %>%
            unname() %>% 
            rep(., k)
    ) %>%
    unlist() %>%
    plot_bar_mcat(n_max = 6, sample_size = length(l_path), collapse = TRUE, colour_gradient = brewer.pal(7, "Reds") %>% .[-7]) + theme(axis.ticks.y = element_blank(), panel.border = element_blank())

# list_table(l_path) %>% heatmap_enrich(1.25, 100)
list.map(l_path, f(i) ~i %>% .[. %in% common_genes]) %>% list_table() %>% select(colnames(.) %>% sort()) %>% heatmap_enrich(1.25, 100)
```

# Network
```{r}
gse_go2 <- remove_cellcycle(gse_go) %>%
  filter_gsea(regex = paste(name_immu2, collapse = "|")) %>%
  pairwise_termsim() %>% 
  clusterProfiler::simplify(cutoff = 0.9)
```

```{r}
map_enrich(
    gse_go2,
    cluster.params = list(cluster = FALSE),
    regex = paste(name_immu, collapse = "|"),
    showCategory = 50,
    cex.params = list(category_label =  0.9, line = 0.5),
    cex = 0.7
)
```

```{r}
tree_enrich(
    gse_go2,
    regex = paste(name_immu0, collapse = "|"),
    showCategory = 50,
    verbose = FALSE,
    label_words_n = 2,
    width = 100
)
```

```{r}
network_enrich(
    gse_go2,
    foldChange = de_genes_ranked,
    regex = paste(cell_paths, collapse = "|"),
    showCategory = 20,
    col_highlight = brewer.pal(8, "Reds") %>% rev(),
    cex = 0.5
)
```

```{r}
ridge_enrich(
    gse_go2,
    regex = paste(cell_paths, collapse = "|"),
    width = 100
)
```

```{r}
gsea_enrich(gse_go2, regex = "eutrophil", geneSetID = seq(5))
```

```{r}
sessionInfo()
```
